---
import Layout from '@layouts/Layout.astro';
import AuthorBio from '@components/AuthorBio.astro';
import CategoryBadge from '@components/CategoryBadge.astro';
import PortableText from '@components/PortableText.astro';
import SocialShare from '@components/SocialShare.astro';
import BlogCard from '@components/BlogCard.astro';
import AdSenseUnit from '@components/AdSenseUnit.astro';
import { fetchAllPosts, fetchPostBySlug, fetchRelatedPosts, calculateReadingTime } from '@data/blog';
import type { Post } from '@data/blog';
import urlBuilder from '@sanity/image-url';
import { client } from '@utils/sanity-client';

export async function getStaticPaths() {
    const posts = await fetchAllPosts();
    return posts.map((post) => ({
        params: { slug: post.slug.current },
        props: { post }
    }));
}

interface Props {
    post: Post;
}

const { post } = Astro.props;

const builder = urlBuilder(client);

function getImageUrl(source: any, width: number) {
    if (!source) return null;
    return builder.image(source).width(width).url();
}

const featuredImageUrl = getImageUrl(post.featuredImage, 1200);
const ogImageUrl = post.seo?.ogImage ? getImageUrl(post.seo.ogImage, 1200) : featuredImageUrl;
const readingTime = calculateReadingTime(post.content);

const publishDate = new Date(post.publishedAt).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

const publishDateISO = new Date(post.publishedAt).toISOString();

// SEO
const pageTitle = post.seo?.metaTitle || post.title;
const pageDescription = post.seo?.metaDescription || post.excerpt;
const canonicalUrl = new URL(`/blog/${post.slug.current}`, Astro.site).toString();

// Fetch related posts
const categoryIds = post.categories?.map(cat => cat._id) || [];
const relatedPosts = await fetchRelatedPosts(post._id, categoryIds, 3);

// JSON-LD structured data
const structuredData = {
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    headline: post.title,
    description: post.excerpt,
    image: featuredImageUrl,
    author: {
        '@type': 'Person',
        name: post.author.name
    },
    publisher: {
        '@type': 'Person',
        name: post.author.name
    },
    datePublished: publishDateISO,
    dateModified: publishDateISO,
    mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': canonicalUrl
    }
};
---

<Layout 
    title={pageTitle} 
    description={pageDescription}
    image={{
        src: ogImageUrl || '',
        alt: post.featuredImage?.alt || ''
    }}
    addTitleSuffix={true}
>
    <!-- Add structured data -->
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

    <article class="blog-post">
        <div class="container">
            <!-- Featured Image -->
            {featuredImageUrl && (
                <div class="featured-image-wrapper">
                    <img
                        src={featuredImageUrl}
                        alt={post.featuredImage?.alt || ''}
                        class="featured-image"
                    />
                </div>
            )}

            <div class="post-layout">
                <!-- Main Content -->
                <div class="post-main">
                    <header class="post-header">
                        {post.categories && post.categories.length > 0 && (
                            <div class="post-categories">
                                {post.categories.map((category) => (
                                    <CategoryBadge category={category} size="md" />
                                ))}
                            </div>
                        )}

                        <h1 class="post-title">{post.title}</h1>

                        <div class="post-meta">
                            <AuthorBio author={post.author} variant="compact" />
                            <div class="meta-details">
                                <time datetime={publishDateISO} class="meta-date">
                                    {publishDate}
                                </time>
                                <span class="meta-separator">â€¢</span>
                                <span class="meta-reading-time">{readingTime} min read</span>
                            </div>
                        </div>
                    </header>

                    <div class="post-content">
                        <PortableText content={post.content} />
                    </div>

                    {post.tags && post.tags.length > 0 && (
                        <div class="post-tags">
                            <span class="tags-label">Tags:</span>
                            {post.tags.map((tag) => (
                                <span class="tag">#{tag}</span>
                            ))}
                        </div>
                    )}

                    <SocialShare title={post.title} url={canonicalUrl} />
                </div>

                <!-- Sidebar -->
                <aside class="post-sidebar">
                    <div class="sidebar-content">
                        <AuthorBio author={post.author} variant="full" />
                        
                        <!-- AdSense in Sidebar -->
                        <div class="sidebar-ad">
                            <AdSenseUnit adFormat="auto" />
                        </div>
                    </div>
                </aside>
            </div>

            <!-- Related Posts -->
            {relatedPosts.length > 0 && (
                <section class="related-posts">
                    <h2 class="related-title">Related Posts</h2>
                    <div class="related-grid">
                        {relatedPosts.map((relatedPost) => (
                            <BlogCard post={relatedPost} />
                        ))}
                    </div>
                </section>
            )}
        </div>
    </article>
</Layout>

<style>
    .blog-post {
        padding: 3rem 0;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
    }

    .featured-image-wrapper {
        margin-bottom: 3rem;
        display: flex;
        justify-content: center;
        background-color: var(--base-200);
        border-radius: 1rem;
        overflow: hidden;
    }

    .featured-image {
        max-width: 100%;
        max-height: 500px;
        width: auto;
        height: auto;
        display: block;
    }

    .post-layout {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 4rem;
        align-items: start;
    }

    .post-main {
        min-width: 0; /* Prevents overflow */
    }

    .post-header {
        margin-bottom: 3rem;
    }

    .post-categories {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .post-title {
        font-size: 3rem;
        font-weight: 800;
        line-height: 1.2;
        color: var(--base-content);
        margin: 0 0 2rem 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .post-meta {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--fallback-bc,oklch(var(--bc)/.1));
    }

    .meta-details {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9375rem;
        color: var(--fallback-bc,oklch(var(--bc)/.7));
    }

    .meta-separator {
        color: var(--fallback-bc,oklch(var(--bc)/.3));
    }

    .post-content {
        margin-bottom: 3rem;
    }

    .post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1.5rem 0;
        border-top: 1px solid var(--fallback-bc,oklch(var(--bc)/.1));
    }

    .tags-label {
        font-weight: 600;
        color: var(--fallback-bc,oklch(var(--bc)/.7));
        font-size: 0.9375rem;
    }

    .tag {
        padding: 0.375rem 0.75rem;
        background-color: var(--base-200);
        color: var(--fallback-bc,oklch(var(--bc)/.7));
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .post-sidebar {
        position: sticky;
        top: 2rem;
    }

    .sidebar-content {
        /* Additional sidebar styles can go here */
    }

    .related-posts {
        margin-top: 6rem;
        padding-top: 3rem;
        border-top: 2px solid var(--fallback-bc,oklch(var(--bc)/.1));
    }

    .related-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--base-content);
        margin: 0 0 2rem 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .related-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
    }

    @media (max-width: 1024px) {
        .post-layout {
            grid-template-columns: 1fr;
            gap: 3rem;
        }

        .post-sidebar {
            position: static;
        }
    }

    @media (max-width: 768px) {
        .blog-post {
            padding: 2rem 0;
        }

        .featured-image-wrapper {
            margin-bottom: 2rem;
        }

        .post-title {
            font-size: 2rem;
        }

        .related-title {
            font-size: 1.5rem;
        }

        .related-grid {
            grid-template-columns: 1fr;
        }

        .related-posts {
            margin-top: 4rem;
        }
    }
</style>
